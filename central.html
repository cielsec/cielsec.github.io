<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Ciel Sec Central - Ferramentas de análise de rede: GeoIP, IP Tracker, DNS, WHOIS/RDAP e Dstat L7" />
  <meta name="theme-color" content="#00ff99" />
  <title>Ciel Sec — Central</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css" />
</head>

<body class="cursor-hidden">
  <a class="skip-link" href="#hub">Pular para a central</a>

  <!-- Background layers -->
  <div class="bg" aria-hidden="true"></div>
  <div class="grid" aria-hidden="true"></div>
  <div class="glow" aria-hidden="true"></div>
  <div class="scanlines" aria-hidden="true"></div>

  <!-- Custom cursor -->
  <div class="cursor-dot" aria-hidden="true"></div>
  <div class="cursor-ring" aria-hidden="true"></div>

  <!-- Transition overlay -->
  <div class="transition-wipe" aria-hidden="true"></div>

  <main class="shell">
    <!-- HERO / TERMINAL -->
    <section id="hero" class="screen is-active" aria-label="Tela inicial">
      <div class="hero-terminal">
        <article class="terminal-window">
          <header class="terminal-bar">
            <div class="terminal-controls" aria-hidden="true">
              <span class="dot red"></span>
              <span class="dot yellow"></span>
              <span class="dot green"></span>
            </div>
            <h1 class="terminal-title">CIEL SEC :: boot sequence</h1>
          </header>

          <div class="terminal-body">
            <div class="terminal-watermark" aria-hidden="true">
              <svg viewBox="0 0 256 256" aria-hidden="true">
                <path d="M128 14l92 36v70c0 66-41 107-92 122C77 227 36 186 36 120V50l92-36Z" />
                <path d="M92 132l26 26 54-70" fill="none" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>

            <div id="boot-lines" class="terminal-lines" aria-live="polite" aria-atomic="true"></div>

            <footer class="terminal-footer">
              <span class="term-cursor" aria-hidden="true"></span>
            </footer>
          </div>
        </article>

        <div id="hero-actions" class="hero-actions hero-actions-hidden">
          <button id="enter-btn" class="btn btn-primary" type="button">
            ENTRAR
          </button>
        </div>

        <footer class="hero-foot">
          <p>Central: <span>GeoIP</span> · <span>IP Tracker</span> · <span>DNS</span> · <span>WHOIS/RDAP</span></p>
        </footer>
      </div>
    </section>

    <!-- HUB / CENTRAL -->
    <section id="hub" class="screen" aria-label="Central de ferramentas" tabindex="-1">
      <header class="hub-header">
        <div class="hub-head">
          <p class="eyebrow">Central de Ferramentas</p>
          <h2>Escolhe o host, roda a ação e lê o resultado no console.</h2>
        </div>
        <div class="hub-line" aria-hidden="true"></div>
        <button class="btn btn-ghost" type="button" data-action="back">VOLTAR</button>
      </header>

      <div class="hub-layout">
        <!-- Navigation -->
        <nav class="hub-menu" aria-label="Módulos de ferramentas">
          <ul class="hub-menu-list">
            <li>
              <button class="hub-btn is-active" type="button" data-panel="central" aria-selected="true">
                <span class="icon" aria-hidden="true">▣</span>
                <span class="label">CENTRAL</span>
              </button>
            </li>
            <li>
              <button class="hub-btn" type="button" data-panel="geoip" aria-selected="false">
                <span class="icon" aria-hidden="true">⌁</span>
                <span class="label">GEOIP</span>
              </button>
            </li>
            <li>
              <button class="hub-btn" type="button" data-panel="iptrack" aria-selected="false">
                <span class="icon" aria-hidden="true">⟟</span>
                <span class="label">IP TRACKER</span>
              </button>
            </li>
            <li>
              <button class="hub-btn" type="button" data-panel="dns" aria-selected="false">
                <span class="icon" aria-hidden="true">⎈</span>
                <span class="label">DNS</span>
              </button>
            </li>
            <li>
              <button class="hub-btn" type="button" data-panel="whois" aria-selected="false">
                <span class="icon" aria-hidden="true">⟐</span>
                <span class="label">WHOIS / RDAP</span>
              </button>
            </li>
            <li>
              <button class="hub-btn" type="button" data-panel="dstatl7" aria-selected="false">
                <span class="icon" aria-hidden="true">▦</span>
                <span class="label">DSTAT L7</span>
              </button>
            </li>
          </ul>
        </nav>

        <!-- Panels -->
        <div class="hub-panels" role="region" aria-label="Painéis de ferramentas">
          <!-- CENTRAL -->
          <section class="hub-panel is-active" data-panel-id="central" aria-labelledby="panel-central-heading">
            <h3 id="panel-central-heading">Central</h3>
            <p class="panel-description">Input do alvo + botões de ação + console de resultados.</p>

            <article class="project-card control-panel">
              <header class="project-head">
                <h4>Alvo / Host</h4>
                <p>IPv4 ou domínio. Enter roda uma ação "inteligente".</p>
              </header>

              <div class="form-grid">
                <div class="form-group">
                  <label for="tool-host" class="drop-label">Host</label>
                  <input 
                    id="tool-host"
                    list="host-sugestoes"
                    placeholder="8.8.8.8 | 1.1.1.1 | example.com"
                    spellcheck="false"
                    autocomplete="off"
                    aria-describedby="host-help"
                  />
                  <datalist id="host-sugestoes">
                    <option value="8.8.8.8">Google DNS</option>
                    <option value="1.1.1.1">Cloudflare DNS</option>
                    <option value="9.9.9.9">Quad9</option>
                    <option value="example.com">Example Domain</option>
                    <option value="cloudflare.com">Cloudflare</option>
                  </datalist>
                  <small id="host-help" class="sr-only">Digite um endereço IP ou nome de domínio</small>
                </div>

                <div class="form-group">
                  <label for="tool-dns-type" class="drop-label">DNS Type (quando usar DNS/PTR)</label>
                  <select id="tool-dns-type">
                    <option value="A">A (IPv4)</option>
                    <option value="AAAA">AAAA (IPv6)</option>
                    <option value="MX">MX (Mail Exchange)</option>
                    <option value="NS">NS (Name Server)</option>
                    <option value="TXT">TXT (Text)</option>
                    <option value="CNAME">CNAME (Canonical Name)</option>
                    <option value="SOA">SOA (Start of Authority)</option>
                    <option value="PTR">PTR (Reverse DNS)</option>
                  </select>
                </div>

                <div class="action-buttons">
                  <button class="btn" type="button" data-tool="geoip">GEOIP</button>
                  <button class="btn" type="button" data-tool="iptrack">IPTRACK</button>
                  <button class="btn" type="button" data-tool="dns">DNS</button>
                  <button class="btn" type="button" data-tool="whois">WHOIS</button>
                  <button class="btn btn-ghost" type="button" id="tool-clear">CLEAR</button>
                  <button class="btn btn-ghost" type="button" id="tool-copy">COPIAR</button>
                </div>

                <div class="status-bar">
                  <div class="status-item">
                    <span class="drop-label">Status:</span>
                    <output id="tool-status" class="drop-value status-ready">READY</output>
                  </div>
                  <div class="status-item source-info">
                    <span class="drop-label">Fonte:</span>
                    <span class="drop-value">ipapi/ipwho · dns.google · rdap.org</span>
                  </div>
                </div>
              </div>
            </article>

            <article class="project-card console-panel">
              <header class="project-head">
                <h4>Console</h4>
                <p>Resultados e erros aparecem aqui.</p>
              </header>

              <div class="drop-codebar">
                <span class="drop-label">Output</span>
                <output id="tool-meta" class="drop-value">—</output>
              </div>

              <pre class="code-block"><code id="tool-output"></code></pre>
              <p class="drop-hint">Dica: se algum endpoint bloquear CORS, você vai ver o erro no console.</p>
            </article>
          </section>

          <!-- GEOIP -->
          <section class="hub-panel" data-panel-id="geoip" aria-labelledby="panel-geoip-heading" hidden>
            <h3 id="panel-geoip-heading">GeoIP</h3>
            <p>Geolocalização + ASN/ORG + timezone. Use IPv4.</p>
            <ul class="feature-list">
              <li><strong>Entrada:</strong> IPv4</li>
              <li><strong>Saída:</strong> cidade/país/coordenadas/ASN/organização</li>
            </ul>
          </section>

          <!-- IP TRACKER -->
          <section class="hub-panel" data-panel-id="iptrack" aria-labelledby="panel-iptrack-heading" hidden>
            <h3 id="panel-iptrack-heading">IP Tracker</h3>
            <p>Combo: GeoIP + RDAP + Reverse DNS (PTR) quando existir.</p>
            <ul class="feature-list">
              <li>GeoIP detalhado</li>
              <li>RDAP (registro / entidades)</li>
              <li>PTR (reverse DNS)</li>
            </ul>
          </section>

          <!-- DNS -->
          <section class="hub-panel" data-panel-id="dns" aria-labelledby="panel-dns-heading" hidden>
            <h3 id="panel-dns-heading">DNS</h3>
            <p>Resolver DNS via DNS-over-HTTPS (Google). Use domínio (ou PTR com IP).</p>
            <ul class="feature-list">
              <li>A/AAAA/MX/NS/TXT/CNAME/SOA</li>
              <li>PTR: reverse de IPv4</li>
            </ul>
          </section>

          <!-- WHOIS -->
          <section class="hub-panel" data-panel-id="whois" aria-labelledby="panel-whois-heading" hidden>
            <h3 id="panel-whois-heading">WHOIS / RDAP</h3>
            <p>RDAP é o "WHOIS moderno" e geralmente funciona melhor no browser do que WHOIS clássico.</p>
            <ul class="feature-list">
              <li>Domínio ou IP</li>
              <li>Status, eventos, nameservers, entidades</li>
            </ul>
          </section>

          <!-- DSTAT L7 -->
          <section class="hub-panel" data-panel-id="dstatl7" aria-labelledby="panel-dstat-heading" hidden>
            <h3 id="panel-dstat-heading">Dstat L7</h3>
            <p>Gráfico remoto L7 (vedbex). Usa o mesmo host/IP do input da Central.</p>

            <article class="project-card">
              <header class="project-head">
                <h4>Graph</h4>
                <p>Render do endpoint /tools/ajax/dstat/L7/graph</p>
              </header>

              <div class="dstat-controls">
                <div class="action-buttons">
                  <button class="btn" type="button" id="dstat-refresh">RECARREGAR</button>
                  <button class="btn btn-ghost" type="button" id="dstat-open">ABRIR EM NOVA ABA</button>
                </div>
                
                <div class="status-item">
                  <span class="drop-label">Status:</span>
                  <output id="dstat-status" class="drop-value status-ready">READY</output>
                </div>
              </div>

              <div class="drop-codebar">
                <span class="drop-label">URL</span>
                <output id="dstat-url" class="drop-value">—</output>
              </div>

              <figure class="dstat-figure">
                <img 
                  id="dstat-img"
                  alt="Gráfico Dstat L7 - estatísticas de rede"
                  loading="lazy"
                  decoding="async"
                  referrerpolicy="no-referrer"
                />
              </figure>

              <p class="drop-hint">Se não aparecer, pode ser bloqueio de hotlink/embeds. Use "Abrir em nova aba".</p>
            </article>
          </section>
        </div>
      </div>

      <footer class="site-footer">
        <p>© <time id="year"></time> Ciel Sec · "método vence sorte"</p>
      </footer>
    </section>
  </main>

  <!-- Tool Engine -->
  <script>
    (function() {
      'use strict';
      
      // Elements
      const els = {
        host: document.getElementById('tool-host'),
        type: document.getElementById('tool-dns-type'),
        output: document.getElementById('tool-output'),
        meta: document.getElementById('tool-meta'),
        status: document.getElementById('tool-status'),
        clear: document.getElementById('tool-clear'),
        copy: document.getElementById('tool-copy'),
        dstatImg: document.getElementById('dstat-img'),
        dstatUrl: document.getElementById('dstat-url'),
        dstatStatus: document.getElementById('dstat-status'),
        dstatRefresh: document.getElementById('dstat-refresh'),
        dstatOpen: document.getElementById('dstat-open'),
        year: document.getElementById('year')
      };

      let lastTool = 'geoip';
      let dstatDebounce;

      // Utilities
      const now = () => new Date().toLocaleString('pt-BR');
      const isIPv4 = ip => /^(\d{1,3}\.){3}\d{1,3}$/.test(ip) && ip.split('.').every(n => +n >= 0 && +n <= 255);
      const looksDomain = d => !!d && !/\s/.test(d) && d.includes('.') && /^[a-zA-Z0-9.-]+$/.test(d) && !d.startsWith('.') && !d.endsWith('.');
      const ipToPTR = ip => ip.split('.').reverse().join('.') + '.in-addr.arpa';

      const setStatus = (text, type) => {
        els.status.textContent = text;
        els.status.className = 'drop-value status-' + (type || 'ready');
        const colors = { ok: 'rgba(0,255,153,.85)', bad: 'rgba(255,77,77,.90)', warn: 'rgba(255,210,77,.95)', ready: 'rgba(0,255,153,.75)' };
        els.status.style.color = colors[type] || colors.ready;
      };

      const log = (s = '') => els.output.textContent += s + '\n';
      const hr = () => log('─'.repeat(72));
      const clear = () => {
        els.output.textContent = '';
        els.meta.textContent = '—';
        setStatus('READY', 'ok');
      };

      // Fetch with timeout
      async function fetchJson(url, opts = {}, timeoutMs = 12000) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), timeoutMs);
        try {
          const r = await fetch(url, { ...opts, signal: ctrl.signal });
          if (!r.ok) {
            const tx = await r.text().catch(() => '');
            throw new Error(`HTTP ${r.status} — ${tx.slice(0, 180)}`);
          }
          const ct = r.headers.get('content-type') || '';
          if (ct.includes('json')) return await r.json();
          const tx = await r.text();
          try { return JSON.parse(tx); } catch { return { raw: tx }; }
        } finally {
          clearTimeout(t);
        }
      }

      // Tools
      async function geoip(ip) {
        setStatus('WORKING', 'warn');
        els.meta.textContent = `GeoIP :: ${ip} :: ${now()}`;
        log(`$ geoip ${ip}`);
        try {
          let j;
          try {
            j = await fetchJson(`https://ipapi.co/${encodeURIComponent(ip)}/json/`);
            if (j?.error) throw new Error(j?.reason || 'ipapi error');
            log(`IP: ${j.ip || ip}`);
            log(`Local: ${j.city || '-'}, ${j.region || '-'} — ${j.country_name || '-'} (${j.country || '-'})`);
            log(`Coords: ${j.latitude ?? '-'}, ${j.longitude ?? '-'}`);
            log(`ASN: ${j.asn || '-'} | Org: ${j.org || '-'}`);
            log(`Timezone: ${j.timezone || '-'}`);
          } catch {
            j = await fetchJson(`https://ipwho.is/${encodeURIComponent(ip)}`);
            if (j?.success === false) throw new Error(j?.message || 'ipwho error');
            log(`IP: ${j.ip || ip}`);
            log(`Local: ${j.city || '-'}, ${j.region || '-'} — ${j.country || '-'} (${j.country_code || '-'})`);
            log(`Coords: ${j.latitude ?? '-'}, ${j.longitude ?? '-'}`);
            log(`ASN: ${j.connection?.asn || '-'} | Org: ${j.connection?.org || '-'}`);
            log(`Timezone: ${j.timezone?.id || '-'}`);
          }
          setStatus('OK', 'ok');
        } catch (e) {
          setStatus('FAIL', 'bad');
          log(`ERRO geoip: ${e.message}`);
        }
        hr();
      }

      async function dns(name, type) {
        setStatus('WORKING', 'warn');
        els.meta.textContent = `DNS :: ${name} :: ${type} :: ${now()}`;
        log(`$ dns ${name} ${type}`);
        try {
          const url = `https://dns.google/resolve?name=${encodeURIComponent(name)}&type=${encodeURIComponent(type)}`;
          const j = await fetchJson(url);
          if (j?.Status !== 0) log(`DNS Status != 0 (${j.Status}).`);
          
          if (j?.Answer?.length) {
            for (const a of j.Answer) log(`${a.name}  TYPE=${a.type}  TTL=${a.TTL}  ${a.data}`);
          } else {
            log('Sem Answer. Tentando Authority/Additional...');
            if (j?.Authority?.length) for (const a of j.Authority) log(`[AUTH] ${a.name} TYPE=${a.type} TTL=${a.TTL} ${a.data}`);
            if (j?.Additional?.length) for (const a of j.Additional) log(`[ADD]  ${a.name} TYPE=${a.type} TTL=${a.TTL} ${a.data}`);
            if (!j?.Authority?.length && !j?.Additional?.length) log('Nada retornado.');
          }
          setStatus('OK', 'ok');
        } catch (e) {
          setStatus('FAIL', 'bad');
          log(`ERRO dns: ${e.message}`);
        }
        hr();
      }

      async function rdap(target) {
        setStatus('WORKING', 'warn');
        els.meta.textContent = `RDAP :: ${target} :: ${now()}`;
        log(`$ whois ${target}`);
        try {
          const url = isIPv4(target) 
            ? `https://rdap.org/ip/${encodeURIComponent(target)}`
            : `https://rdap.org/domain/${encodeURIComponent(target)}`;
          const j = await fetchJson(url, { headers: { accept: 'application/rdap+json, application/json' } });
          
          log(`Handle: ${j.handle || '-'}`);
          if (j.ldhName) log(`Nome: ${j.ldhName}`);
          if (j.status) log(`Status: ${Array.isArray(j.status) ? j.status.join(', ') : j.status}`);
          
          if (Array.isArray(j.events)) {
            for (const ev of j.events) {
              if (ev?.eventAction && ev?.eventDate) {
                const key = (ev.eventAction || '').toLowerCase();
                if (['registration', 'last changed', 'expiration', 'transfer', 'last update of rdap database'].includes(key)) {
                  log(`${ev.eventAction}: ${ev.eventDate}`);
                }
              }
            }
          }
          
          if (Array.isArray(j.nameservers) && j.nameservers.length) {
            log('Nameservers:');
            for (const ns of j.nameservers.slice(0, 25)) log(` - ${ns.ldhName || ns.name || '-'}`);
          }
          setStatus('OK', 'ok');
        } catch (e) {
          setStatus('FAIL', 'bad');
          log(`ERRO whois/rdap: ${e.message}`);
          log('Obs: WHOIS clássico geralmente quebra por CORS; RDAP é o caminho certo no browser.');
        }
        hr();
      }

      async function iptrack(ip) {
        setStatus('WORKING', 'warn');
        els.meta.textContent = `IPTRACK :: ${ip} :: ${now()}`;
        log(`$ iptrack ${ip}`);
        try {
          hr();
          await geoip(ip);
          await rdap(ip);
          await dns(ipToPTR(ip), 'PTR');
          setStatus('OK', 'ok');
        } catch (e) {
          setStatus('FAIL', 'bad');
          log(`ERRO iptrack: ${e.message}`);
          hr();
        }
      }

      // Main run function
      async function run(tool) {
        const host = (els.host.value || '').trim();
        const type = (els.type.value || 'A').toUpperCase();
        if (!host) {
          setStatus('SEM HOST', 'bad');
          els.meta.textContent = 'Informe um host/IP.';
          return;
        }

        lastTool = tool;

        if (tool === 'dns') {
          if (type === 'PTR') {
            if (!isIPv4(host)) {
              setStatus('PTR precisa IP', 'bad');
              els.meta.textContent = 'PTR precisa de IPv4.';
              return;
            }
            return dns(ipToPTR(host), 'PTR');
          }
          return dns(host, type);
        }

        if (tool === 'geoip') {
          if (!isIPv4(host)) {
            setStatus('GeoIP precisa IP', 'bad');
            els.meta.textContent = 'GeoIP precisa de IPv4.';
            return;
          }
          return geoip(host);
        }

        if (tool === 'iptrack') {
          if (!isIPv4(host)) {
            setStatus('IPTRACK precisa IP', 'bad');
            els.meta.textContent = 'IPTRACK precisa de IPv4.';
            return;
          }
          return iptrack(host);
        }

        if (tool === 'whois') {
          if (!isIPv4(host) && !looksDomain(host)) {
            setStatus('Host inválido', 'bad');
            els.meta.textContent = 'Use IPv4 ou domínio.';
            return;
          }
          return rdap(host);
        }
      }

      // Event listeners
      document.addEventListener('click', e => {
        const b = e.target.closest?.('[data-tool]');
        if (b) {
          run(b.getAttribute('data-tool'));
          return;
        }
      });

      els.clear?.addEventListener('click', clear);

      els.copy?.addEventListener('click', async () => {
        const txt = els.output.textContent || '';
        if (!txt.trim()) return;
        try {
          await navigator.clipboard.writeText(txt);
          setStatus('COPIADO ✓', 'ok');
          setTimeout(() => setStatus('READY', 'ok'), 900);
        } catch {
          setStatus('FALHA copy', 'bad');
        }
      });

      els.host?.addEventListener('keydown', e => {
        if (e.key !== 'Enter') return;
        const host = (els.host.value || '').trim();
        if (isIPv4(host)) {
          run(lastTool === 'dns' ? 'iptrack' : lastTool);
        } else if (looksDomain(host)) {
          run(lastTool === 'geoip' || lastTool === 'iptrack' ? 'dns' : lastTool);
        } else {
          setStatus('Host inválido', 'bad');
          els.meta.textContent = 'Formato inválido.';
        }
      });

      // Dstat L7
      const setDstatStatus = (text, type) => {
        if (!els.dstatStatus) return;
        els.dstatStatus.textContent = text;
        els.dstatStatus.className = 'drop-value status-' + type;
        const colors = { ok: 'rgba(0,255,153,.85)', bad: 'rgba(255,77,77,.90)', warn: 'rgba(255,210,77,.95)', ready: 'rgba(0,255,153,.75)' };
        els.dstatStatus.style.color = colors[type] || colors.ready;
      };

      const buildDstatUrl = ipOrHost => `https://www.vedbex.com/tools/ajax/dstat/L7/graph?ip=${encodeURIComponent(ipOrHost)}&title=false`;

      const loadDstat = () => {
        const host = (els.host?.value || '').trim();
        if (!host) {
          setDstatStatus('SEM HOST', 'bad');
          if (els.dstatUrl) els.dstatUrl.textContent = 'Informe um host/IP na aba Central.';
          if (els.dstatImg) els.dstatImg.removeAttribute('src');
          return;
        }

        const url = buildDstatUrl(host);
        if (els.dstatUrl) els.dstatUrl.textContent = url;

        setDstatStatus('LOADING', 'warn');
        if (els.dstatImg) {
          els.dstatImg.onload = () => setDstatStatus('OK', 'ok');
          els.dstatImg.onerror = () => setDstatStatus('FAIL', 'bad');
          els.dstatImg.src = url + '&t=' + Date.now();
        }
      };

      els.dstatRefresh?.addEventListener('click', loadDstat);
      els.dstatOpen?.addEventListener('click', () => {
        const host = (els.host?.value || '').trim();
        if (!host) return;
        window.open(buildDstatUrl(host), '_blank', 'noopener,noreferrer');
      });

      els.host?.addEventListener('input', () => {
        clearTimeout(dstatDebounce);
        dstatDebounce = setTimeout(loadDstat, 450);
      });

      // Init
      clear();
      log(`[${now()}] Ciel Sec Central pronta.`);
      log('Dica: host + GEOIP / IPTRACK / DNS / WHOIS. (Enter roda rápido)');
      hr();
      loadDstat();
      
      // Set year
      if (els.year) els.year.textContent = new Date().getFullYear();
    })();
  </script>

  <script src="app.js"></script>
</body>
</html>
